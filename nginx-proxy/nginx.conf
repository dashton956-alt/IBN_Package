events {
    worker_connections 1024;
}

http {
    # Basic settings
    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 500M;
    
    # Upstream services
    upstream netbox {
        server 172.30.133.89:8080;
    }
    
    upstream n8n {
        server 172.30.133.89:5678;
    }
    
    upstream anythingllm {
        server 172.30.133.89:3001;
    }
    
    upstream stackstorm {
        server 172.30.133.89:80;
    }

    # HTTPS Server - Corporate Firewall Bypass
    server {
        listen 443 ssl;
        server_name 172.30.133.89;
        
        # SSL Configuration
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;

        # Root - Service Menu
        location = / {
            return 200 'Corporate Firewall Bypass - Port 443 Access

Choose your service:
• Netbox:      https://172.30.133.89/netbox
• N8N:         https://172.30.133.89/n8n  
• AnythingLLM: https://172.30.133.89/llm
• StackStorm:  https://172.30.133.89/st2

All services accessible through HTTPS port 443 only.
';
            add_header Content-Type text/plain;
        }

        # Netbox - Simple proxy without subpath complexity
        location /netbox/ {
            proxy_pass http://netbox/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Netbox without trailing slash - redirect
        location /netbox {
            return 301 https://$host/netbox/;
        }

        # Netbox static and media files - direct proxy to container
        location ~ ^/(static|media)/ {
            proxy_pass http://172.30.133.89:8080$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # N8N - Full proxy
        location /n8n {
            rewrite ^/n8n/?(.*)$ /$1 break;
            proxy_pass http://n8n;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_redirect ~^http://[^/]+(/.+)$ https://$host/n8n$1;
        }

        # AnythingLLM - Full proxy
        location /llm {
            rewrite ^/llm/?(.*)$ /$1 break;
            proxy_pass http://anythingllm;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for AnythingLLM
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_redirect ~^http://[^/]+(/.+)$ https://$host/llm$1;
            
            # Long timeouts for AI processing
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }

        # StackStorm - Full proxy
        location /st2 {
            rewrite ^/st2/?(.*)$ /$1 break;
            proxy_pass http://stackstorm;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for StackStorm
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_redirect ~^http://[^/]+(/.+)$ https://$host/st2$1;
        }

        # Health check
        location /health {
            return 200 '{"status": "ok", "message": "All services accessible via HTTPS 443"}';
            add_header Content-Type application/json;
        }
    }
}
