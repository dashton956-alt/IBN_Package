---
version: '2.0'

ibn_workflows.comprehensive_device_management:
  description: "Comprehensive device management using multiple glueware services"
  input:
    - device_serial
    - operation_type  # configure, monitor, troubleshoot
  tasks:
    start_operation:
      action: core.echo
      input:
        message: "Starting {{ operation_type }} operation for {{ device_serial }}"
      on-success:
        - call_inventory_service

    call_inventory_service:
      action: core.http
      input:
        url: "http://inventory-service:7000/devices/{{ device_serial }}"
        method: "GET"
        headers:
          Authorization: "Bearer {{ st2kv.system.inventory_token }}"
        timeout: 15
      publish:
        device_info: <% task(call_inventory_service).result.body %>
      on-success:
        - call_wingpy_service
      on-error:
        - log_inventory_error

    call_wingpy_service:
      action: core.http
      input:
        url: "http://wingpy:8080/device-info"
        method: "POST"
        body:
          device_identifier: <% $.device_serial %>
          platform: <% $.device_info.get('platform', 'meraki') %>
          operation: "get_full_status"
          credentials:
            api_key: "{{ st2kv.system.meraki_api_key }}"
      publish:
        live_status: <% task(call_wingpy_service).result.body %>
      on-success:
        - call_analytics_service
      on-error:
        - fallback_to_direct_api

    call_analytics_service:
      action: core.http
      input:
        url: "http://analytics-service:8000/analyze"
        method: "POST"
        body:
          device_data: <% $.live_status %>
          historical_data: <% $.device_info %>
          analysis_type: "health_prediction"
      publish:
        analytics_result: <% task(call_analytics_service).result.body %>
      on-success:
        - generate_report

    generate_report:
      action: core.local
      input:
        cmd: |
          cat > /tmp/device_report_{{ device_serial }}.json << EOF
          {
            "device_serial": "{{ device_serial }}",
            "operation_type": "{{ operation_type }}",
            "inventory_data": {{ device_info | jsonify }},
            "live_status": {{ live_status | jsonify }},
            "analytics": {{ analytics_result | jsonify }},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "services_used": ["inventory", "wingpy", "analytics"]
          }
          EOF
          echo "Report generated: /tmp/device_report_{{ device_serial }}.json"
      on-success:
        - send_to_dashboard

    send_to_dashboard:
      action: core.http
      input:
        url: "http://dashboard-service:9000/reports"
        method: "POST"
        body: <% task(generate_report).result.stdout %>

    log_inventory_error:
      action: core.echo
      input:
        message: "Inventory service unavailable, continuing with reduced data"
      on-success:
        - call_wingpy_service

    fallback_to_direct_api:
      action: ibn_workflows.meraki_api
      input:
        action_type: "get_device"
        serial: <% $.device_serial %>
      publish:
        live_status: <% task(fallback_to_direct_api).result %>
      on-success:
        - call_analytics_service
